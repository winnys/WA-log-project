---
title: "Diversity comparison"
author: "Winnie Siu"
date: "2023-12-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(vegan)
require(dplyr)
require(tidyr)
require(labdsv)
require(stringr)
require(ggplot2)
require(ggrepel)
require(lme4)
require(emmeans)
require(lmerTest)
require(performance)
require(ggpubr)
require(DHARMa)
```

### Data wrangling

This dataset does not include unknown data.
```{r}
comm <- read.csv("20-22_species_composition_data_no_unk.csv", header = T)
```

Remove the locations surveyed in 2021 and 2022 that were not surveyed in 2020 - aka, cm=0, cm=21, cm = 22, cm = 29.
```{r}
comm<-comm[which(comm$cm_location!=21 & comm$cm_location!=0 & comm$cm_location!=22 & comm$cm_location!=29),]

# make a group name for each row

comm$grp<-apply(comm[c(1,3,5,6,7)], 1, paste, collapse=":") # timepoint, block, transect_name, initial state
```

Need to make each row a community using matrify
```{r}
commsub<-comm[,c(15,10,13)] 
# group, species_code, and count of each species for each transect. transects are rows.

commsub <-as.data.frame(commsub)
commtry<-labdsv::matrify(commsub) # make it an expanded species matrix 
commtry$x[which(is.na(commtry$x))] <- 1  # "x" means that there were no individuals in the transect, but we are going to keep track of this as if it were a species
ncol(commtry) # how many species are we working with in our community matrix
```

Store grouping row names as a column, then remove rownames.
```{r}
commtry$grps<-rownames(commtry)
rownames(commtry)<-NULL
names(commtry)
```

Split group info into columns for each variable
```{r}
mat<-separate(commtry, 88, c("time","block","transect","init","treatment"), ":")
names(mat) #check
```
Add groupname using time, block, init columns
```{r}
mat$grp<-apply(mat[c(88:92)], 1, paste, collapse=":")
names(mat) #check
```

Another df where the grouping variables are time, block, transect and initial state.
Each row is a transect in a certain year.
```{r}
df<-mat[,c(1:87,93)]
df2 = df %>% mutate(across(.cols=1:87,.fns=as.numeric)) # make everything numeric
rownames(df2)<-NULL # remove rownames
```

\newpage
**Diversity**<br>
Next, I look at the diversity of microtransect plants in log vs open plots in 2020. For the below analysis, I take a conservative approach and only include known species, because most of the unknown species were a result of not being able to differentiate between known species. Diversity is Shannon's diversity index and estimated by pooling the species in each treatment type in each block (N=14). Shannon's diversity is not different between the two environments.  

### 1. Species diversity analysis at t0 (block level)
Main takeways:

* Shannon diversity index is summarized at block level
* div.mod tells us init does not significantly affect plant diversity
* we should move on to analyzing diversity index on transect levels

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE, results=TRUE}

# make numeric
numat = mat %>% mutate(across(.cols=1:87,.fns=as.numeric)) # make everything numeric

# sum species for each group (grouped by init, block, time)
nudat<-numat%>% 
  group_by(init, block, time) %>% summarise(across(where(is.numeric), sum))

# make a data frame
dat<-as.data.frame(nudat) # this df contains block level diversity from all years
dat1<-dat[which(dat$time=="t0"),] # just t0

#estimate diversity for each row/group. don't include 'x' 

# no groups, just estimate diversity of each row
est<-dat1[,c(4:89)]
dat1$diversity<-diversity(est, index='shannon') 
```

```{r message=FALSE, warning=FALSE, include=TRUE, results='markup'}
library(lmerTest)

# what does our data look like? 
hist(dat1$diversity, xlab = "Shannon diversity index", ylab = "Frequency", main = "Histogram of Shannon diversity index (block level)") # pretty normal!

## model, this time I can add a random effect for block. diversity in this case is shannon's diversity of each transect 
div.mod<-lmer(diversity~init+(1|block), data=dat1)

# summary 
summary(div.mod)
round(summary(div.mod)$coeff, 4)
coef(div.mod)$block

# plot of difference - not significant.  # how is it concluded? #
emmip(div.mod, ~init, CI=T)+theme_bw()+labs(x="Initial condition", y="Shannon Diversity")

# wait a minute! 
# should we look at the diversity different at the block scale?
# calculating diversity on 'block' level masks variability within a block
# when including block as the random effect (in the intercept), we essentially have 1 data point for each group in each block (also see summary(div.mod))
# calculating plant diversity at transect level also makes the interpretation more intuitive
ggplot(dat1, aes(x = as.factor(init), y = diversity, fill = as.factor(init))) +
  geom_boxplot(position = "dodge", alpha = 0.5) +
  labs(x = "init",
       y = "Diversity") +
  scale_fill_discrete(name = 'init') +
  theme_classic() +
  facet_grid(. ~ block) +
  stat_compare_means(comparisons = list(c("log", "open")), label = "p.format", method="wilcox.test")
```

Main concluding note:

-0.1932 is the gradient between open microsite and log microsite.
'initopen' and 'Ã­nitlog' are arranged in alphabetic order, so here it will mean the diversity level goes from log to open.
In terms of the plant diversity, it is reduced by 0.1932 unit when we go from log to open areas. 
We should also look at the r squared value to determine whether it is a good regression.
If you want to compare two models, run anova of the two model: anova(model1, model2) where model1 has fixed effect a and b; model2 has only a.
if the anova tells us p-value is very small, it is suggesting that factor b has a significant contribution to the overall model.

Random slope and random intercept:
In the fixed effect estimate, we expect that diversity in every block has the same respond of dropping by 0.1932 unit from log to open.
This is allowing the intercept and slope of the relation between ind block and diversity to vary within a range. This is to avoid a false positive. But if we do not have enough sample groups to assign different gradients, it is hard to do this part.

From here on, analysis on species diversity will be on transect level.

### 2. Species diversity analysis at t0 (transect level)
Calculating shannon diversity for each transect.
```{r message=FALSE, warning=FALSE, include=TRUE, results='markup'}
# make numeric
numat = mat %>% mutate(across(.cols=1:87,.fns=as.numeric)) # make everything numeric

# sum species for each group (grouped by init, transect, block, time)
nudat2<-numat%>% 
  group_by(init, transect, block, time) %>% summarise(across(where(is.numeric), sum))

# make a data frame
dat2<-as.data.frame(nudat2) # this df contains transect levels from all years
dat3<-dat2[which(dat2$time=="t0"),] # just t0

#estimate diversity for each row/group. don't include 'x' 

# no groups, just estimate diversity of each row
est2<-dat3[,c(5:90)]
dat3$diversity<-diversity(est2, index='shannon') 
```

##### 2.1 Linear mixed effect regression
Main takeways:

* transect level diversity (Shannon index) is zero inflated
* if we ignore this zero inflation and model the general data with a linear mixed effect model
* div.mod2 tells us that init does not significantly affect plant diversity
```{r message=FALSE, warning=FALSE, include=TRUE, results='markup'}
# what does our data look like? 
hist(dat3$diversity, xlab = "Shannon index", ylab= "Frequency", main = "Histogram of Shannon diversity index (transect level)") # the distribution of the data looks zero-inflated

shapiro.test(dat3$diversity) # not normal

ggplot(dat3, aes(x = diversity, fill = as.factor(init))) +
  geom_density(position = "identity", alpha = 0.5, bins = 30) +
  labs(x = "Diversity",
       y = "Frequency") +
  scale_fill_discrete(name = 'init')

# including random term for block. diversity in this case is shannon's diversity of each transect 
div.mod2<-lmer(diversity~init+(1|block), data=dat3)

# summary 
summary(div.mod2)

# plot of difference - not significant.
emmip(div.mod2, ~init, CI=T)+theme_bw()+labs(x="Initial condition", y="Shannon Diversity")

# test zero inflation - very zero inflated
testZeroInflation(simulateResiduals(div.mod2))
```
##### 2.2 Hurdle model 
Main takeaways:

* since transect level diversity (Shannon index) is zero inflated
* we will address zero inflation with a hurdle model
* the first part includes modelling probability of zero in a logistic regression
* m1 tells us init does not significantly determine the probability of non-zero diversity index
* the second part includes modelling the non-zero component
* m2 (assumed an approximal Gaussian distribution) tells us init does not significantly affect plant diversity
```{r message=FALSE, warning=FALSE, include = TRUE, results='markup'}
# separate into zero and non-zero observations
dat3$non_zero <- ifelse(dat3$diversity > 0, 1, 0)

ggplot(dat3,
       aes(x = as.factor(init), y = diversity, fill = as.factor(init))) + 
  geom_boxplot(position = "dodge", alpha = 0.5) +
  facet_grid(. ~ block) +
  geom_jitter(position = position_jitter(width = 0.1, height = 0.1)) + 
  theme_classic()

# what does our data look like? 
hist(dat3$diversity, xlab = "Shannon index", ylab= "Frequency", main = "Histogram of Shannon diversity index (transect level)")

ggplot(dat3, aes(x = diversity, fill = as.factor(non_zero))) + # separating into zero and non-zero components
  geom_histogram(position = "identity", alpha = 0.5, bins = 30) +
  labs(x = "Shannon diversity",
       y = "Frequency") +
  scale_fill_discrete(name = 'non_zero') +
  theme_bw()


# first part of a hurdle model
# logistic regression to predict the probability of non-zero
m1 <- glmer(non_zero ~ init+(1|block), data = dat3, family = binomial)
summary(m1)

# second part models non-zero values
# is the non-zero data normal?
shapiro.test(dat3$diversity[dat3$non_zero == 1]) # distribution of non-zero values is not normal

hist(dat3$diversity[dat3$non_zero == 1], xlab="Shannon diversity (non-zero)", main="Histogram of non-zero diversity index") # visually resembles to a normal distribution

# since the distribution of non-zero diversity indexes resembles to a normal distribution and the data is continuous
# we treat it as a gaussian distribution as this stage
# lmer to model the mean of the non-zero data with block as the random term
m2<- lmer(diversity ~ init+(1|block), data=subset(dat3, non_zero == 1)) # not significant
summary(m2)

# plot of difference - not significant.
emmip(m2, ~init, CI=T)+theme_bw()+labs(x="Initial condition", y="Shannon Diversity")
```

### 3. Species diversity analysis all years (transect level) 
This part calculate Shannon diversity of each transect affected solely by initial log and open treatment from all three years.
```{r message=FALSE, warning=FALSE, include = TRUE, results='markup'}
# make numeric
numat = mat %>% mutate(across(.cols=1:87,.fns=as.numeric)) # make everything numeric

# sum species for each group (grouped by init, transect, block, time)
nudat2<-numat%>% 
  group_by(time, block, transect, init, treatment) %>% summarise(across(where(is.numeric), sum))

# make a data frame
dat2<-as.data.frame(nudat2) # this df contains transect levels from all years
dat3 <- dat2[which(dat2$time=="t0" |  dat2$treatment=="open" |  dat2$treatment=="insitu_log"),]

#estimate diversity for each row/group. don't include 'x' 

# no groups, just estimate diversity of each row
est3<-dat3[,c(6:91)]
dat3$diversity<-diversity(est3, index='shannon') 
```

##### 3.1 Lmer of all data
Main takeaways:

* assuming an approximal Gaussian distribution of diversity data
* we use a lmer with block and time as random terms
* plant diversity is significantly higher in log plots than open plots
* now we also need to address zero-inflation, go to the next section
```{r message=FALSE, warning=FALSE, include = TRUE, results='markup'}
# what does our data look like? 
hist(dat3$diversity, xlab = "Shannon diversity (transect level)", main = "Histogram of Shannon diversity index (all years, transect level)") # zero-inflated

shapiro.test(dat3$diversity) # not normal

ggplot(dat3, aes(x = diversity, fill = as.factor(init))) +
  geom_density(position = "identity", alpha = 0.5, bins = 30) +
  labs(x = "Shannon diversity",
       y = "Frequency") +
  scale_fill_discrete(name = 'init')

# if we ignore zero-inflation, 
# and model the general plant diversity (Shannon's diversity index in each transect) across all years with a lmer, 
# with block and time as the random terms (assumes block effect and time effect are fixed)
# plant diversity in log environment is significantly higher in open environment!!
div.mod4<-lmer(diversity~init+(1|block)+(1|time), data=dat3)

# summary 
summary(div.mod4)

# plot of difference - significant.
emmip(div.mod4, ~init, CI=T)+theme_bw()+labs(x="Initial condition", y="Shannon Diversity")

# test zero inflation - very zero inflated
testZeroInflation(simulateResiduals(div.mod4))
```
##### 3.2 Hurdle model
Main takeaways:

* we use a hurdle model to address zero-inflation
* we first use logistic regression to predict the probability of non-zero
* open and log environment significantly determines the probability of non-zero diversity index
* note, zero in Shannon diversity index does not mean zero plant. 
* we then use lmer to model non-zero diversity data with time and block as random terms
* we assume approximal Gaussian distribution (1) continuous variable and (2) visual inspection suggests so
```{r message=FALSE, warning=FALSE, include=TRUE, results='markup', fig.width =8, fig.height=8}
# separate into zero and non-zero observations
dat3$non_zero <- ifelse(dat3$diversity > 0, 1, 0)

# what does our data look like? 
hist(dat3$diversity, xlab = "Shannon diversity", main = "Histogram of Shannon diversity index (all years, transect level)") # zero-inflated

ggplot(dat3, aes(x = diversity, fill = as.factor(non_zero))) +
  geom_histogram(position = "identity", alpha = 0.5, bins = 30) +
  labs(x = "Diversity",
       y = "Frequency") +
  scale_fill_discrete(name = 'non_zero') +
  theme_bw()

shapiro.test((dat3$diversity[dat3$non_zero == 1])) # non-zero data is not normal

hist(dat3$diversity[dat3$non_zero ==1], xlab = "Shannon diversity index (non-zero)", main = "Histogram of Shannon diversity index (non-zero, all years, transect level)") # visually it resembles a lot like a Gaussian distribution 

# long story short I chose Gaussian distribution

# I struggle on the link function
# skip this part if you're not interested in the distribution type decision making 
#####
# how to decide on the link function?
dat3_nonzerodat <- dat3[dat3$non_zero == 1, ]
hist(dat3$diversity, xlab = "Shannon diveristy(non-zero)")
ggplot(dat3_nonzerodat, aes(x = diversity, fill=as.factor(time))) +
  geom_density(position = "identity", alpha = 0.5, bins = 30)
# the bimodal distribution seemed to be caused by t0 data

# following plots provide qqplot on different distribution types.
ggplot(dat3_nonzerodat, aes(sample = diversity)) + 
                  geom_qq(distribution = qnorm) + 
                  geom_qq_line(distribution = qnorm) +
                  ggtitle("normal")

ggplot(dat3_nonzerodat, aes(sample = diversity)) + 
                  geom_qq(distribution = qlnorm) + 
                  geom_qq_line(distribution = qlnorm) +
                  ggtitle("Log-normal")

ggplot(dat3_nonzerodat, aes(sample = diversity)) + 
                geom_qq(distribution = qpois, dparams = list(lambda=1000)) + 
                geom_qq_line(distribution = qpois, dparams = list(lambda=1000)) +
                ggtitle("Poisson")

library(MASS)
fit <- fitdistr(dat3_nonzerodat$diversity, densfun = "gamma")
shape_est <- fit$estimate["shape"]
rate_est <- fit$estimate["rate"]

ggplot(dat3_nonzerodat, aes(sample = diversity)) + 
  geom_qq(distribution = qgamma, dparams = list(shape = shape_est, rate = rate_est)) + 
  geom_qq_line(distribution = qgamma, dparams = list(shape = shape_est, rate = rate_est)) +
  ggtitle("Gamma")

fit <- fitdistr(dat3_nonzerodat$diversity, densfun = "weibull")

# Access the estimated parameters
shape_est <- fit$estimate["shape"]
scale_est <- fit$estimate["scale"]


ggplot(dat3_nonzerodat, aes(sample = diversity)) + 
  geom_qq(distribution = qweibull, dparams = list(shape = shape_est, scale = scale_est)) + 
  geom_qq_line(distribution = qweibull, dparams = list(shape = shape_est, scale = scale_est)) +
  ggtitle("Weibull")
#####
## back to the hurdle model
# logistic regression to predict the probability of non-zero
# open and log environment does determine the probability of non-zero diversity index
# 0 shannon diversity index =/= zero plants
m4 <- glmer(non_zero ~ init + (1|block) + (1|time), data = dat3, family = binomial)
summary(m4) # significant

# lmer to predict the mean of the non-zero data.
# we include block and time as random terms
# open and log environment is significant in explaining the plant diversity in transect levels.
# lmer is used here because the distribution of non-zero data looks normal
m5 <- lmer(diversity ~ init + (1|block)+ (1|time), data=subset(dat3, non_zero == 1))
summary(m5)
anova(m5) # lmer on non-zero diversity values is significant

# check residual
# Extract residuals
residuals <- resid(m5)
plot(residuals)
abline(0,0)
plot(m5)
library(performance)
check_model(m5)
# https://www.researchgate.net/post/Why-do-the-residuals-need-to-be-normal-when-carrying-out-multi-level-modeling
# I like this explanation of non-normality in residuals. because log-open as a categorical factor is a very coarse predictor. it does not include a lot of information in telling us the diversity.
```